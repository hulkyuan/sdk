import IAction from '../IAction';
import { transformData, utf16to8, utf8to16 } from '../DataFormat';
import IResponse from './issueEInvoice/IResponse';
import { parseString } from 'xml2js';
import builder from 'xmlbuilder';
import base64 from 'base-64';
import { toAt } from '../DataFormat';
import request from 'superagent';
import IRequest from './IRequest';

//金税
export default class HangXin implements IAction {
    mockDayin = {
        "business": {
            "_comment": "发票打印",
            "_id": "FPDY",
            "body": {
                "_yylxdm": "1",
                "input": {
                    "nsrsbh": "50022619881093002X",
                    "skpbh": "54357887",
                    "skpkl": "3424234",
                    "keypwd": "456456456",
                    "fplxdm": "004",
                    "fpdm": "3200192130",
                    "fphm": "25618551",
                    "dylx": "9",
                    "dyjmc": "",
                    "dyfs": "1"
                }
            }
        }
    };
    mockZuofei = {
        "business": {
            "_comment": "发票作废",
            "_id": "FPZF",
            "body": {
                "_yylxdm": "1",
                "input": {
                    "nsrsbh": "50022619881093002X",
                    "skpbh": "54357887",
                    "skpkl": "3424234",
                    "keypwd": "456456456",
                    "fplxdm": "004",
                    "zflx": "1",
                    "fpdm": "3200192130",
                    "fphm": "25610903",
                    "hjje": "377.88",
                    "zfr": ""
                }
            }
        }
    };
    mockKaiju = {
        "business": {
            "_comment": "发票开具",
            "_id": "FPKJ",
            "body": {
                "_yylxdm": "1",
                "input": {
                    "skpbh": "54357887",
                    "skpkl": "3424234",
                    "keypwd": "456456456",
                    "fplxdm": "004",
                    "kplx": "0",
                    "tspz": "00",
                    "xhdwsbh": "91320102575938948G",
                    "xhdwmc": "南京苏宁易购电子商务有限公司",
                    "xhdwdzdh": "南京市玄武区玄武大道699-19号8幢 电话025-66996699",
                    "xhdwyhzh": "中国建设银行南京徐庄软件园支行 32001881436052508322",
                    "ghdwsbh": "91110106MA005RPX7Y",
                    "ghdwmc": "国电(北京)配送中心有限公司",
                    "ghdwdzdh": "北京市丰台区南四环西路188号十二区17号楼2层-1号（园区）010-58688415",
                    "ghdwyhzh": "建行北京宣武支行11050167360000000932",
                    "bmbbbh": "",
                    "hsslbs": "0",
                    "fyxm": {
                        "_count": "1",
                        "group": {
                            "_xh": "1",
                            "fphxz": "0",
                            "spmc": "得力0012订书钉24/6统一订书针 12号标准型钉书针 50盒 总共50000枚",
                            "spsm": "",
                            "ggxh": "0012",
                            "dw": "件",
                            "spsl": "1.000000",
                            "dj": "62.830000",
                            "je": "62.83",
                            "kcje": "",
                            "sl": "0.13",
                            "se": "8.17",
                            "hsbz": "0",
                            "spbm": "1090222060000000000",
                            "zxbm": "",
                            "yhzcbs": "0",
                            "slbs": "",
                            "zzstsgl": ""
                        }
                    },
                    "zhsl": "",
                    "hjje": "62.83",
                    "hjse": "8.17",
                    "jshj": "71.00",
                    "bz": "KPTZ20191118090434",
                    "skr": "周晓曼",
                    "fhr": "张伟伟",
                    "kpr": "李晓云",
                    "jmbbh": "",
                    "zyspmc": "",
                    "spsm": "",
                    "qdbz": "0",
                    "ssyf": "",
                    "kpjh": "",
                    "tzdbh": "",
                    "yfpdm": "",
                    "yfphm": "",
                    "qmcs": "0000004282000000"
                }
            }
        }
    };
    request: IRequest;
    fpkj = (url, data): Promise<any> => {
        // this.sendData(url,data);
        return this.send(url, this.mockKaiju);
    }
    fpdy = (url, data) => {
        return this.send(url, this.mockDayin);
    }
    fpzf = (url, data): Promise<any> => {
        return this.send(url, this.mockZuofei);
    }
    fphm = (url) => {
        return this.send(url, {});
    }
    send = (url, data): Promise<any> => {
        // 真实开票用到的请求，将js对象转换xml字符串
        const reqXml = builder.create(toAt(transformData('shuikong', data))).end({ pretty: true });
        const encodeData: string = base64.encode(utf16to8(reqXml));
        const response = this.Seeya(url, { args: encodeData });
        return response;
    }
    Seeya = (url: string, data: IRequest): Promise<any> => {
        return request.post(url).type('form').send(data).then(res => {
            const response: IResponse = utf8to16(base64.decode(res.body));
            console.log(JSON.stringify(response));
            return response;
        }).then(res => {
            return new Promise((resolve, reject) => {
                parseString(
                    res,
                    { explicitArray: false },
                    (err, result: any) => {
                        if (err) {
                            return reject(err);
                        }
                        console.log('result', result);
                        resolve(result);
                    }
                );
            });
        });
    }
} 